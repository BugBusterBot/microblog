{% extends "base.html" %}
{% import "bootstrap_wtf.html" as wtf %}

{% block content %}

<div class="container-fluid py-3">
  <div class="d-flex align-items-center mb-3">
    <h1 class="h3 mb-0">Quản Lý Nguồn Dữ Liệu</h1>
  </div>

  {# -- Filter area: prefer server-provided form (filter_form). If present use bootstrap_wtf.quick_form.
        If not present render a Bootstrap form with same field names so frontend JS can use it. -- #}
  <div class="row mb-3">
    <div class="col-12 col-lg-8">
      {% if filter_form %}
        {{ wtf.quick_form(filter_form, action=url_for('datasources'), method='get', id='filter-form') }}
      {% else %}
        <form id="filter-form" class="row gx-2 gy-2 align-items-center">
          <div class="col-12 col-md-6">
            <label for="q" class="form-label visually-hidden">Tìm kiếm</label>
            <input id="q" name="q" class="form-control" placeholder="Tìm kiếm..." />
          </div>
          <div class="col-6 col-md-2">
            <label for="status" class="form-label visually-hidden">Trạng thái</label>
            <select id="status" name="status" class="form-select">
              <option value="">Tất cả trạng thái</option>
              <option value="ok">Bảo mật</option>
              <option value="insecure">Không đạt bảo mật</option>
            </select>
          </div>
          <div class="col-6 col-md-1">
            <button id="btn-filter" class="btn btn-primary w-100" type="submit">Lọc</button>
          </div>
          <div class="col-6 col-md-1">
            <button id="btn-reset" class="btn btn-outline-secondary w-100" type="button">Reset</button>
          </div>
        </form>
      {% endif %}
    </div>

    <div class="col-12 col-lg-4 d-flex align-items-center justify-content-lg-end mt-2 mt-lg-0">
      <div class="text-muted small">Danh sách chi tiết của "Số lượng log đã nhập".</div>
    </div>
  </div>

  <hr>

  <!-- Import / delete accordion -->
  <div class="accordion mb-3" id="importAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingImport">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseImport" aria-expanded="false" aria-controls="collapseImport">
          Import Dữ Liệu / Xóa toàn bộ dữ liệu
        </button>
      </h2>
      <div id="collapseImport" class="accordion-collapse collapse" aria-labelledby="headingImport" data-bs-parent="#importAccordion">
        <div class="accordion-body">
          <div class="d-flex flex-column flex-sm-row gap-2">
            <button id="btn-delete-all" class="btn btn-outline-danger">Xóa toàn bộ dữ liệu</button>
            <div class="align-self-start text-muted">Hoạt động này sẽ xóa mọi log — backend phải xác nhận.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <hr>

  <div class="mb-2 d-flex justify-content-between align-items-center">
    <div class="text-muted">Danh sách log (chi tiết)</div>
    <div class="text-muted">Kết quả: <span id="results-info" class="badge bg-light text-body">--</span></div>
  </div>

  <!-- Logs table -->
  <div class="table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th style="width:90px">ID</th>
          <th>Tên log</th>
          <th style="width:140px">Nguồn</th>
          <th style="width:160px">Ngày nhập</th>
          <th style="width:140px">Trạng thái</th>
          <th style="width:120px">Hành động</th>
        </tr>
      </thead>
      <tbody id="logs-tbody" aria-live="polite">
        <tr id="loading-row">
          <td colspan="6" class="text-center py-4">
            <div class="spinner-border text-secondary" role="status" aria-hidden="true"></div>
            <div class="mt-2 text-muted">Đang tải dữ liệu...</div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-between align-items-center mt-3">
    <div id="empty-note" class="text-muted"></div>
    <div>
      <button id="btn-load-more" class="btn btn-outline-secondary" style="display:none">Tải thêm</button>
    </div>
  </div>
</div>

{# -- Minimal JS to fetch and render logs; uses Bootstrap only for styling -- #}
<script>
(function () {
  const useMock = false; // set true while backend not ready
  const API_LIST = '/api/logs';
  const API_DELETE_ALL = '/api/logs';

  let page = 1;
  const pageSize = 20;
  let totalResults = 0;

  function fmtDate(iso){
    try {
      const d = new Date(iso);
      return d.toLocaleString('vi-VN', {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
    } catch (e) { return iso || ''; }
  }

  function fmtNum(n){ return n == null ? '-' : n.toLocaleString('vi-VN'); }

  function escapeHtml(str){
    if (!str) return '';
    return str.replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }

  function renderRow(log){
    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td><span class="badge bg-light text-body">${escapeHtml(String(log.id || ''))}</span></td>
      <td>${escapeHtml(log.title || '')}</td>
      <td>${escapeHtml(log.source || '')}</td>
      <td>${escapeHtml(fmtDate(log.created_at || ''))}</td>
      <td>${log.status === 'insecure' ? '<span class="badge bg-danger">Không đạt</span>' : '<span class="badge bg-success">Bảo mật</span>'}</td>
      <td><a class="btn btn-sm btn-outline-primary" href="/logs/${encodeURIComponent(log.id)}">Xem</a></td>
    `;
    return tr;
  }

  async function safeFetchJson(url){
    const r = await fetch(url, { cache: 'no-store' });
    if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    return r.json();
  }

  async function loadLogs({ reset = false } = {}) {
    const tbody = document.getElementById('logs-tbody');
    const resultsInfo = document.getElementById('results-info');
    const loadMoreBtn = document.getElementById('btn-load-more');
    const emptyNote = document.getElementById('empty-note');

    if (reset) {
      page = 1;
      totalResults = 0;
      tbody.innerHTML = `
        <tr id="loading-row">
          <td colspan="6" class="text-center py-4">
            <div class="spinner-border text-secondary" role="status" aria-hidden="true"></div>
            <div class="mt-2 text-muted">Đang tải dữ liệu...</div>
          </td>
        </tr>`;
      emptyNote.textContent = '';
    } else {
      const loadingRow = document.createElement('tr');
      loadingRow.id = 'loading-more';
      loadingRow.innerHTML = `<td colspan="6"><div class="text-center py-2"><div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div> Đang tải thêm...</div></td>`;
      tbody.appendChild(loadingRow);
    }

    try {
      if (useMock) {
        const mockTotal = 55;
        const logs = [];
        const start = (page - 1) * pageSize + 1;
        for (let i = 0; i < Math.min(pageSize, mockTotal - (page-1)*pageSize); i++){
          const id = start + i;
          logs.push({ id, title: `Tiêu đề sample ${id}`, source: 'dantri', created_at: new Date().toISOString(), status: id % 5 === 0 ? 'insecure' : 'ok' });
        }
        totalResults = mockTotal;
        if (reset) tbody.innerHTML = '';
        else { const lr = document.getElementById('loading-more'); if (lr) lr.remove(); }
        logs.forEach(l => tbody.appendChild(renderRow(l)));
        resultsInfo.textContent = `${fmtNum(totalResults)} kết quả`;
        page += 1;
        loadMoreBtn.style.display = ((page-1)*pageSize >= totalResults) ? 'none' : 'inline-block';
        if (totalResults === 0) emptyNote.textContent = 'Không có log phù hợp với bộ lọc.';
        return;
      }

      const q = (document.getElementById('q') && document.getElementById('q').value.trim()) || '';
      const source = (document.getElementById('source') && document.getElementById('source').value) || '';
      const status = (document.getElementById('status') && document.getElementById('status').value) || '';

      const params = new URLSearchParams();
      if (q) params.append('search', q);
      if (source) params.append('source', source);
      if (status) params.append('status', status);
      params.append('page', page);
      params.append('page_size', pageSize);

      const url = `${API_LIST}?${params.toString()}`;
      const data = await safeFetchJson(url);

      const logs = data.logs || [];
      totalResults = data.total ?? ((page - 1) * pageSize + logs.length);

      if (reset) tbody.innerHTML = '';
      else { const lr = document.getElementById('loading-more'); if (lr) lr.remove(); }

      logs.forEach(l => tbody.appendChild(renderRow(l)));

      resultsInfo.textContent = `${fmtNum(totalResults)} kết quả`;

      if ((reset && logs.length === 0) || totalResults === 0) {
        emptyNote.textContent = 'Không có log phù hợp với bộ lọc.';
      } else {
        emptyNote.textContent = '';
      }

      page += 1;
      loadMoreBtn.style.display = ((page-1)*pageSize >= totalResults) ? 'none' : 'inline-block';

    } catch (err) {
      console.error('Lỗi khi tải logs', err);
      const lr = document.getElementById('loading-more');
      if (lr) lr.remove();
      tbody.innerHTML = `<tr><td colspan="6" class="text-danger py-3">Không thể tải dữ liệu. Vui lòng thử lại sau.</td></tr>`;
      resultsInfo.textContent = '--';
      loadMoreBtn.style.display = 'none';
    }
  }

  // hook form and buttons
  document.addEventListener('DOMContentLoaded', function () {
    const filterForm = document.getElementById('filter-form');
    if (filterForm) {
      filterForm.addEventListener('submit', function (e) {
        e.preventDefault();
        loadLogs({ reset: true });
      });
    }

    const resetBtn = document.getElementById('btn-reset');
    if (resetBtn) {
      resetBtn.addEventListener('click', function () {
        if (document.getElementById('q')) document.getElementById('q').value = '';
        if (document.getElementById('source')) document.getElementById('source').value = '';
        if (document.getElementById('status')) document.getElementById('status').value = '';
        loadLogs({ reset: true });
      });
    }

    const loadMoreBtn = document.getElementById('btn-load-more');
    if (loadMoreBtn) {
      loadMoreBtn.addEventListener('click', function () { loadLogs({ reset: false }); });
    }

    const deleteAllBtn = document.getElementById('btn-delete-all');
    if (deleteAllBtn) {
      deleteAllBtn.addEventListener('click', async function () {
        if (!confirm('Bạn có chắc muốn xóa toàn bộ dữ liệu? Hành động này không thể hoàn tác.')) return;
        try {
          if (useMock) {
            alert('Đã xóa (mock).');
            loadLogs({ reset: true });
            return;
          }
          const res = await fetch(API_DELETE_ALL, { method: 'DELETE' });
          if (!res.ok) throw new Error('Server trả về ' + res.status);
          alert('Xóa thành công.');
          loadLogs({ reset: true });
        } catch (err) {
          console.error(err);
          alert('Không thể xóa dữ liệu: ' + err.message);
        }
      });
    }

    // initial load
    loadLogs({ reset: true });
  });
})();
</script>

{% endblock %}